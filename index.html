<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>GeoWay Orbital Drone Tour ‚Äî Profesional</title>

<script src="https://cesium.com/downloads/cesiumjs/releases/1.134/Build/Cesium/Cesium.js"></script>
<link href="https://cesium.com/downloads/cesiumjs/releases/1.134/Build/Cesium/Widgets/widgets.css" rel="stylesheet">

<style>
html,body,#cesiumContainer{width:100%;height:100%;margin:0;padding:0;background:#0b0d11}

/* === Bot√≥n de men√∫ === */
#menuToggle {
  position:absolute; top:12px; left:12px;
  background:#ff6600; color:#fff; border:none;
  border-radius:6px; font-size:18px;
  padding:6px 10px; cursor:pointer;
  z-index:11; box-shadow:0 4px 12px rgba(0,0,0,.4);
}
#menuToggle:hover { background:#ff8533; }

/* === Panel lateral === */
#controlPanel{
  position:absolute; top:60px; left:12px;
  background: rgba(18,20,24,0.95);
  color:#eee;
  padding:12px;
  border-radius:10px;
  width:260px;
  box-shadow:0 6px 20px rgba(0,0,0,.6);
  z-index:10;
  font-family:Arial, sans-serif;
  transition: transform .3s ease;
}
#controlPanel.hidden { transform: translateX(-280px); }

#controlPanel h3{color:#ff6600;margin:4px 0 8px 0;text-align:center}
#controlPanel label{display:flex;align-items:center;justify-content:space-between;margin:6px 0;font-size:13px}
#controlPanel input[type="checkbox"]{margin-right:8px}
#controlPanel select{width:100%;padding:6px;border-radius:6px;border:0;margin-top:6px}
#controlPanel button{
  margin-top:8px;width:100%;padding:8px;border-radius:6px;border:0;
  background:#ff6600;color:#fff;cursor:pointer;
  font-weight:bold;transition:background .2s ease;
}
#controlPanel button:hover { background:#ff8533; }
#stopBtn{background:#444!important;}

/* === Bot√≥n de ayuda (Hotspots permanentes) === */
.info-btn {
  background:none;
  border:none;
  color:#ff9933;
  font-size:16px;
  cursor:pointer;
  padding:0 4px;
}
.info-btn:hover { color:#fff; }

/* === Modal emergente de informaci√≥n === */
#infoModal {
  position:fixed;
  top:0;left:0;width:100%;height:100%;
  background:rgba(0,0,0,0.6);
  display:none;align-items:center;justify-content:center;
  z-index:100;
}
#infoModal.visible { display:flex; }
#infoModal .content {
  background:#1c1f25;
  color:#eee;
  padding:20px;
  border-radius:12px;
  max-width:420px;
  text-align:justify;
  box-shadow:0 8px 25px rgba(0,0,0,.5);
  position:relative;
}
#infoModal .content h2 { color:#ff6600; margin-top:0; text-align:center; }
#infoModal .close-btn {
  position:absolute; top:8px; right:10px;
  color:#aaa; font-size:20px;
  background:none; border:none; cursor:pointer;
}
#infoModal .close-btn:hover { color:#fff; }

/* === Leyenda desplegable === */
#legendToggle {
  position: absolute;
  /* Posiciona el bot√≥n a 80px del borde inferior y 12px del borde izquierdo */
  bottom: 80px;
  right: 12px; 
  background: #222;
  color: #fff;
  border: none;
  border-radius: 6px;
  padding: 6px 10px;
  font-size: 13px;
  cursor: pointer;
  z-index: 11;
  box-shadow: 0 4px 12px rgba(0, 0, 0, .4);
}
#legendToggle:hover {
  background: #fffdfd;
}
#legendPanel {
  position: absolute;
  /* Posiciona el panel a 120px del borde inferior y 12px del borde izquierdo (alineado con el bot√≥n) */
  bottom: 120px; 
  right: 12px;
  display: none;
  background: rgba(255, 255, 255, 0.95);
  border-radius: 10px;
  padding: 8px;
  z-index: 10;
  box-shadow: 0 6px 2px rgb(255, 255, 255);
}
#legendPanel.visible { display:block; }

#logo{position:absolute;left:350px;bottom:1px;height:42px;z-index:11}
#logo-secundario{position:absolute;left:480px;bottom:1px;height:40px;z-index:11}

#credits{position:absolute;right:10px;bottom:10px;color:#ddd;font-size:11px;z-index:11}
</style>
</head>

<body>
<div id="cesiumContainer"></div>

<button id="menuToggle">‚ò∞ Men√∫</button>

<div id="controlPanel">
  <h3>Explorador de Anomal√≠as T√©rmicas</h3>

  <strong>Global Wildfire Information System - GWIS</strong>
  <label><span>MODIS (EFFIS)</span><input type="checkbox" id="modisLayer" checked></label>
  <label><span>VIIRS (EFFIS)</span><input type="checkbox" id="viirsLayer" checked></label>

  <strong style="display:block;margin-top:8px;">
    Hotspots permanentes üî•
    <button class="info-btn" id="infoBtn" title="Hotspot permanente">¬øQu√© es un hotspot permanente?</button>
  </strong>
  <label><span>üè≠Plantas de metales no ferrosos</span><input type="checkbox" id="flareLayer" checked></label>
  <label><span>üè≠Plantas de cemento</span><input type="checkbox" id="cementLayer" checked></label>
  <label><span>üè≠Centrales el√©ctricas</span><input type="checkbox" id="plantLayer" unchecked></label>
  <label><span>üè≠Chimeneas</span><input type="checkbox" id="chimLayer" unchecked></label>
  <label><span>üè≠Plantas Petroquimicas</span><input type="checkbox" id="etilLayer" unchecked></label>

  <strong style="display:block;margin-top:8px;">Edificios 3D</strong>
  <label><span>Edificios LOD</span><input type="checkbox" id="buildingsLayer" checked></label>

  <hr style="border:none;border-top:1px solid rgba(255,255,255,0.06);margin:8px 0">

  <strong>Ejemplos</strong>
  <select id="exampleSelect">
    <option value="california">EEUU (Marathon - Galveston Bay Refinery)</option>
    <option value="australia">Australia (Central El√©ctrica de Melburne)</option>
    <option value="europa">Espa√±a (Central el√©ctrica de Abo√±o)</option>
  </select>
  <button id="startBtn">Iniciar √≥rbita</button>
  <button id="stopBtn">Detener √≥rbita</button>
</div>

<button id="legendToggle">üìä Leyenda</button>
<div id="legendPanel"><img src="images/legend.png" alt="Leyenda" width="240"></div>

<!-- ===================== MODAL Hotspot Permanente ===================== -->
<div id="infoModal">
  <div class="content">
    <button class="close-btn">&times;</button>
    <h2>La Importancia de Conocer los Hotspots Permanentes en Teledetecci√≥n de Incendios Forestales</h2>
    <img src="images/flaregas.jpg" alt="Hotspot Permanente - Quema de gas en antorcha" 
         style="width:100%; max-width:500px; display:block; margin:15px auto; border-radius:10px;">

    <p>
      La <b>teledetecci√≥n satelital</b> es la herramienta m√°s eficaz para el monitoreo global de incendios forestales 
      en tiempo casi real. Sensores t√©rmicos como 
      <a href="https://earthdata.nasa.gov/earth-observation-data/near-real-time/firms" target="_blank">MODIS</a> y 
      <a href="https://earthdata.nasa.gov/earth-observation-data/near-real-time/firms/viirs-i-band-active-fire-data" target="_blank">VIIRS</a> 
      de la NASA detectan anomal√≠as de temperatura en la superficie terrestre, conocidas como <i>‚Äúhotspots‚Äù</i> o puntos de calor.
    </p>

<p>
  Sin embargo, el monitoreo del fuego activo presenta un desaf√≠o clave:
</p>

<blockquote class="highlight-quote">
  ‚ÄúNo todos los incendios son detectables, ni todo lo detectado son incendios.‚Äù
  <br>
  <span class="author">
    ‚Äî <a href="https://www.linkedin.com/in/mar%C3%ADa-isabel-cruz-l%C3%B3pez-9334716a/?originalSubdomain=mx" target="_blank">Dra. Isabel Cruz L√≥pez</a>, CONABIO (M√©xico)
  </span>
</blockquote>

<p>
  Esta afirmaci√≥n resume uno de los mayores retos en la teledetecci√≥n del fuego activo, 
  y subraya la necesidad de identificar y eliminar los <b>hotspots permanentes</b> 
  para evitar interpretaciones err√≥neas en los sistemas de monitoreo satelital.
</p>


    <h3>¬øQu√© son y por qu√© filtrarlos?</h3>
    <p>
      Un <b>hotspot permanente</b> es una fuente de calor recurrente o constante, generada por actividades humanas no relacionadas 
      con la vegetaci√≥n, como <b>plantas de cemento, fundiciones, quemas de gas en antorcha</b> o <b>procesos geot√©rmicos</b>.
      Si no se identifican y filtran estos puntos fijos del conjunto de datos, se producir√°n <b>falsas alarmas</b> que pueden 
      saturar los sistemas de alerta temprana y desviar recursos valiosos.
    </p>

    <p>
      La exclusi√≥n de estos puntos es un paso <b>mandatorio</b> en la fase de preprocesamiento de los datos de detecci√≥n de fuego activo. 
      De lo contrario, cada paso del sat√©lite sobre estas fuentes t√©rmicas podr√≠a interpretarse err√≥neamente como un nuevo incendio.
    </p>

    <h3>Impacto en la Precisi√≥n y la Investigaci√≥n</h3>
    <p>
      Filtrar rigurosamente los <i>falsos positivos</i> permite a los sistemas de gesti√≥n de incendios forestales enfocarse 
      √∫nicamente en anomal√≠as que representan una amenaza real. 
      Estudios en <i>Remote Sensing</i> y otras revistas de alto impacto destacan que el 
      <b>enmascaramiento de fuentes industriales fijas</b> (identificadas en los hotspots permanentes) es esencial para 
      lograr una <b>precisi√≥n superior al 95%</b> en la distinci√≥n entre incendios reales y otras fuentes de calor.
    </p>

    <p>
      En s√≠ntesis, <b>conocer y descontar los hotspots permanentes</b> garantiza la integridad de los datos t√©rmicos, 
      permitiendo que la informaci√≥n satelital evolucione de una simple <i>detecci√≥n de calor</i> 
      a una <b>detecci√≥n confiable de incendios forestales</b>.
    </p>
  </div>
</div>

<!-- ======= Estilos del modal ======= -->
<style>

.highlight-quote {
  background: rgba(255, 153, 51, 0.1);
  border-left: 4px solid #ffa726;
  margin: 12px 0;
  padding: 12px 16px;
  font-style: italic;
  color: #ffcc80;
  font-size: 15px;
  line-height: 1.5;
  border-radius: 6px;
}

.highlight-quote .author {
  display: block;
  margin-top: 6px;
  text-align: right;
  font-size: 13px;
  color: #ccc;
}

.highlight-quote a {
  color: #29b6f6;
  text-decoration: none;
}

.highlight-quote a:hover {
  text-decoration: underline;
  color: #4fc3f7;
}



  #infoModal {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.8);
    backdrop-filter: blur(4px);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 100;
    animation: fadeIn 0.3s ease;
  }

  #infoModal .content {
    position: relative;
    background: rgba(20,22,26,0.95);
    padding: 25px;
    border-radius: 12px;
    max-width: 700px;
    width: 90%;
    max-height: 85%;
    overflow-y: auto;
    box-shadow: 0 8px 30px rgba(0,0,0,0.7);
    color: #eee;
    font-family: "Segoe UI", sans-serif;
    line-height: 1.6;
    animation: slideUp 0.4s ease;
  }

  #infoModal h2 { color: #ffa726; font-size: 20px; margin-bottom: 10px; }
  #infoModal h3 { color: #ffb74d; margin-top: 15px; }
  #infoModal a { color: #29b6f6; text-decoration: none; }
  #infoModal a:hover { text-decoration: underline; }

  .close-btn {
    position: absolute;
    top: 10px;
    right: 15px;
    background: transparent;
    border: none;
    color: #fff;
    font-size: 28px;
    cursor: pointer;
  }
  .close-btn:hover { color: #ff4444; }

  @keyframes fadeIn { from {opacity: 0;} to {opacity: 1;} }
  @keyframes slideUp { from {transform: translateY(20px);} to {transform: translateY(0);} }
</style>


<div class="logo-container">
    <img id="logo" src="images/Logo5.png" alt="Logo Principal">
    <img id="logo-secundario" src="images/redlatif.png" alt="Logo Secundario">
</div>
<div id="credits">Geoway 2025, With the colaboration of Redlatf |- ¬© Cesium | ¬© OpenStreetMap</div>

<script>
Cesium.Ion.defaultAccessToken = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiI1ZjA1NGQ3ZS0xYmViLTRkYjUtODgzNy0wYjZhN2RkOTc2NzMiLCJpZCI6NTc5ODMsImlhdCI6MTc2MTY1NjMzMn0.kP1vTCnx99T9mHM7psPv7wzS9hwLV3eKbKyvGYtY_kw";

// === L√≥gica UI ===
document.getElementById('menuToggle').onclick = () => {
  document.getElementById('controlPanel').classList.toggle('hidden');
};

const infoModal = document.getElementById('infoModal');
document.getElementById('infoBtn').onclick = () => infoModal.classList.add('visible');
infoModal.querySelector('.close-btn').onclick = () => infoModal.classList.remove('visible');

const legendToggle = document.getElementById('legendToggle');
const legendPanel = document.getElementById('legendPanel');
legendToggle.onclick = () => legendPanel.classList.toggle('visible');

// === Cesium Init ===
async function init() {
  const viewer = new Cesium.Viewer('cesiumContainer', {
    terrain: Cesium.Terrain.fromWorldTerrain(),
    baseLayerPicker: true,
    geocoder: true,
    timeline: false,
    animation: false
  });
  viewer.scene.globe.depthTestAgainstTerrain = false;

// ---------- Edificios 3D ----------
  const buildings = await Cesium.createOsmBuildingsAsync();
  viewer.scene.primitives.add(buildings);
  document.getElementById('buildingsLayer').onchange = e => buildings.show = e.target.checked;

  // ---------- MODIS / VIIRS ----------
  const today = new Date();
  const yesterday = new Date(today); yesterday.setDate(today.getDate()-1);
  const iso = d=>d.toISOString().split('T')[0];
  const dateRange = `${iso(yesterday)}/${iso(today)}`;

  const modis = viewer.imageryLayers.addImageryProvider(new Cesium.WebMapServiceImageryProvider({
    url:'https://maps.effis.emergency.copernicus.eu/gwis',
    layers:'modis.hs',
    parameters:{transparent:true, format:'image/png', time:dateRange}
  }));
  const viirs = viewer.imageryLayers.addImageryProvider(new Cesium.WebMapServiceImageryProvider({
    url:'https://maps.effis.emergency.copernicus.eu/gwis',
    layers:'viirs.hs',
    parameters:{transparent:true, format:'image/png', time:dateRange}
  }));
  document.getElementById('modisLayer').onchange = e => modis.show = e.target.checked;
  document.getElementById('viirsLayer').onchange = e => viirs.show = e.target.checked;

  // ---------- Hotspots permanentes ----------

// ---------- üî• Explorador de Hotspots Permanentes (Optimizado) ----------

// Elemento de carga (spinner)
const loader = document.createElement("div");
loader.id = "loadingOverlay";
loader.innerHTML = `
  <div class="spinner"></div>
  <p>Cargando capa...</p>
`;
Object.assign(loader.style, {
  display: "none",
  position: "absolute",
  top: "50%",
  left: "50%",
  transform: "translate(-50%, -50%)",
  background: "rgba(0,0,0,0.7)",
  color: "#fff",
  padding: "15px 25px",
  borderRadius: "10px",
  zIndex: "9999",
  textAlign: "center",
  fontFamily: "Arial, sans-serif"
});
document.body.appendChild(loader);

// Animaci√≥n del spinner
const style = document.createElement("style");
style.innerHTML = `
  .spinner {
    border: 4px solid rgba(255,255,255,0.3);
    border-top: 4px solid #ff6600;
    border-radius: 50%;
    width: 30px;
    height: 30px;
    animation: spin 0.8s linear infinite;
    margin: 0 auto 10px auto;
  }
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
`;
document.head.appendChild(style);

// Funci√≥n gen√©rica para cargar GeoJSON con √≠cono SVG
async function loadGeoJSON(url, iconUrl, color) {
  try {
    loader.style.display = "block"; // Mostrar spinner
    const ds = await Cesium.GeoJsonDataSource.load(url, { clampToGround: true });
    viewer.dataSources.add(ds);

    ds.entities.values.forEach(ent => {
      ent.billboard = new Cesium.BillboardGraphics({
        image: iconUrl,
        scale: 0.4,
        verticalOrigin: Cesium.VerticalOrigin.BOTTOM,
        heightReference: Cesium.HeightReference.CLAMP_TO_GROUND
      });

      ent.label = new Cesium.LabelGraphics({
        text: ent.properties?.name?.getValue() || "Hotspot",
        font: "12px sans-serif",
        fillColor: color.withAlpha(0.9),
        pixelOffset: new Cesium.Cartesian2(0, -25),
        showBackground: false
      });
    });

    return ds;
  } catch (e) {
    console.error(`‚ùå Error cargando ${url}:`, e);
    alert(`No se pudo cargar la capa: ${url}`);
    return null;
  } finally {
    loader.style.display = "none"; // Ocultar spinner
  }
}

// Configuraci√≥n de capas (lazy loading)
const layerConfigs = {
  flareLayer:  { file: "data/Nonferrous_Metal_Processing_Plants_7269968143129708118.geojson", color: Cesium.Color.RED },
  cementLayer: { file: "data/cement_plants.geojson", color: Cesium.Color.ORANGE },
  plantLayer:  { file: "data/global_power_plant_database.geojson", color: Cesium.Color.YELLOW },
  chimLayer:   { file: "data/flare_volume_and_intensity.geojson", color: Cesium.Color.CYAN },
  etilLayer:   { file: "data/SFI_ALD_Global_Ethylene_Database_October_2024.geojson", color: Cesium.Color.MAGENTA }
};

const fireIcon = "images/Fire.svg";
const loadedLayers = {}; // almacenamiento en cach√© de capas ya cargadas

for (const id in layerConfigs) {
  const checkbox = document.getElementById(id);
  const cfg = layerConfigs[id];

  checkbox.onchange = async e => {
    const checked = e.target.checked;

    if (checked && !loadedLayers[id]) {
      // Cargar la capa solo la primera vez
      loadedLayers[id] = await loadGeoJSON(cfg.file, fireIcon, cfg.color);
    }

    if (loadedLayers[id]) {
      loadedLayers[id].show = checked;
    }
  };

  checkbox.checked = false;
}


  // ---------- Centros ----------
  const orbitalCenters = {
    california: { lon: -94.921584, lat: 29.373240, height: 700 },
    australia:  { lon: 	142.6673, lat:-38.06328, height: 500 },
    europa:     { lon: -5.7235501, lat: 43.5601143, height: 300 }
  };

  // ---------- √ìrbita ----------
  let orbitalState = { running: false, intervalId: null };

  function drawOrbitCircle(center, radius) {
    viewer.entities.removeById('orbitCircle');
    viewer.entities.add({
      id: 'orbitCircle',
      position: Cesium.Cartesian3.fromDegrees(center.lon, center.lat, center.height),
      ellipse: {
        semiMajorAxis: radius,
        semiMinorAxis: radius,
        height: center.height,
        material: Cesium.Color.ORANGE.withAlpha(0.18),
        outline: true,
        outlineColor: Cesium.Color.ORANGE
      }
    });
  }

// ... (c√≥digo anterior)

  async function startOrbit(centerKey, params) {
    const center = orbitalCenters[centerKey];
    if (!center) return;
    drawOrbitCircle(center, params.radius);

    orbitalState.running = true;
    const { radius, duration, vAmp } = params;
    // Aumentar steps para una √≥rbita m√°s suave
    const steps = Math.max(120, Math.round(duration * 6)); 
    const stepDuration = duration / steps;

    // 1. FlyTo para acercarse al objetivo
    await viewer.camera.flyTo({
      destination: Cesium.Cartesian3.fromDegrees(center.lon, center.lat, center.height + radius * 1.5),
      duration: 1.2
    });

    let step = 0;
    orbitalState.intervalId = setInterval(() => {
      if (!orbitalState.running) { clearInterval(orbitalState.intervalId); return; }
      
      const angle = (2 * Math.PI * step) / steps;
      
      // Coordenadas de la c√°mara en la √≥rbita (longitud, latitud)
      const offsetLon = (radius / 111000) * Math.cos(angle);
      const offsetLat = (radius / 111000) * Math.sin(angle);
      
      const camLon = center.lon + offsetLon;
      const camLat = center.lat + offsetLat;
      const camHeight = center.height + vAmp * Math.sin(angle);
      
      const cameraPosition = Cesium.Cartesian3.fromDegrees(camLon, camLat, camHeight);
      
      // C√ÅLCULO DEL HEADING (RUMBO) para mirar al centro:
      const heading = Math.atan2(center.lat - camLat, center.lon - camLon) + Cesium.Math.toRadians(90);

      // USAR setView PARA MOVIMIENTO CONTINUO:
      viewer.camera.setView({
        destination: cameraPosition,
        orientation: {
          heading: heading,
          pitch: Cesium.Math.toRadians(-20), // Inclinaci√≥n hacia abajo
          roll: 0
        }
      });
      
      step = (step + 1) % steps;
    }, stepDuration * 1000); 
  }

  function stopOrbit() {
    orbitalState.running = false;
    if (orbitalState.intervalId) clearInterval(orbitalState.intervalId);
    viewer.entities.removeById('orbitCircle');
    // Mueve la c√°mara ligeramente para liberar el control
    viewer.camera.flyTo({
        destination: viewer.camera.position, 
        duration: 0.5,
        offset: new Cesium.HeadingPitchRange(0, 0, 1)
    });
  }

  // --- UI Handlers (Depurado con par√°metros fijos) ---
  const startBtn = document.getElementById('startBtn');
  const stopBtn = document.getElementById('stopBtn');
  const exampleSelect = document.getElementById('exampleSelect');
  
  // Valores fijos para la √≥rbita (antes se le√≠an de los inputs eliminados)
  const ORBIT_PARAMS = {
    radius: 300,
    duration: 30,
    vAmp: 30
  };

  startBtn.onclick = () => {
    // 1. OBTENER la clave del selector
    const key = exampleSelect.value;
    
    stopOrbit();
    // 2. Usar valores fijos para los par√°metros
    startOrbit(key, ORBIT_PARAMS);
  };
  stopBtn.onclick = stopOrbit;

// ... (resto del c√≥digo)
  // ---------- Panel de informaci√≥n ----------
  const infoContent = document.getElementById('infoContent');
  const handler = new Cesium.ScreenSpaceEventHandler(viewer.scene.canvas);

  handler.setInputAction(click => {
    const picked = viewer.scene.pick(click.position);
    if (Cesium.defined(picked) && picked.id && picked.id.properties) {
      const props = picked.id.properties;
      const rows = Object.keys(props).map(k => {
        let val = props[k];
        if (val && val.getValue) val = val.getValue();
        return `<tr><th>${k}</th><td>${val}</td></tr>`;
      }).join('');
      infoContent.innerHTML = `<table>${rows}</table>`;
    } else {
      infoContent.innerHTML = "<em>Sin propiedades disponibles.</em>";
    }
  }, Cesium.ScreenSpaceEventType.LEFT_CLICK);

  // ---------- Vista inicial ----------
  viewer.camera.flyTo({
    destination: Cesium.Cartesian3.fromDegrees(-74.0, 4.0, 50000),
    orientation: { heading: Cesium.Math.toRadians(25), pitch: Cesium.Math.toRadians(-20) },
    duration: 2
  });
}

init();
</script>
</body>
</html>
